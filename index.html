<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' https://script.google.com https://script.googleusercontent.com https://cdnjs.cloudflare.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Green Now - Katowice 4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .kontener { background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        .login-kontener { align-self: center; text-align: center; }
        h1, h2, h3 { color: #005b41; text-align: center; }
        .etap { border: none; padding-top: 10px; margin-top: 10px; }
        label { display: block; margin-top: 15px; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; background-color: #f9f9f9; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: #008170; outline: none; }
        button { background-color: #008170; color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 20px; font-weight: bold; width: 100%; transition: background-color 0.3s; }
        button:hover { background-color: #005b41; }
        .ukryty { display: none; }
        #stale-podsumowanie { border: 2px solid #008170; border-radius: 8px; margin-top: 40px; padding: 20px; background-color: #fafffd; }
        #lista-wybranych-elementow { list-style-type: none; padding-left: 0; margin-bottom: 20px; }
        #lista-wybranych-elementow li { background-color: #e8f5e9; padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 0.9em; }
        .form-buttons { display: flex; gap: 10px; margin-top: 30px; }
    </style>
</head>
<body>

    <div id="prosty-login" class="kontener login-kontener">
        <h2>Dostęp do kalkulatora</h2>
        <label>Wprowadź hasło:</label>
        <input type="password" id="haslo-dostepu" placeholder="Hasło...">
        <button id="btn-zaloguj">Odblokuj</button>
        <p id="login-error" style="color:red; margin-top:10px; height: 20px;"></p>
    </div>

    <div id="glowny-kalkulator" class="kontener ukryty">
        <div id="etapy-kontener">
            <div id="etap1" class="etap">
                <h1>Etap 1: Konfiguracja Instalacji</h1>
                <label for="typ-pokrycia">System montażowy:</label>
                <select id="typ-pokrycia">
                    <option value="">-- wybierz system --</option>
                    <option value="TRAPEZ">TRAPEZ</option>
                    <option value="DACHÓWKA">DACHÓWKA</option>
                    <option value="BLACHODACHÓWKA">BLACHODACHÓWKA</option>
                    <option value="EKIERKI">EKIERKI INWAZYJNE</option>
                    <option value="GRUNT">GRUNT</option>
                </select>
                
                <label>ZESTAWY RISEN 450W + Inwerter Sieciowy DEYE SUN:</label>
                <select id="zestaw-sieciowy" class="lista-produktow" disabled></select>
                
                <label>ZESTAWY RISEN 450 + Inwerter hybrydowy DEYE + MAGAZYN NISKONAPIĘCIOWY:</label>
                <select id="zestaw-niskonapieciowy" class="lista-produktow" disabled></select>
                
                <label>ZESTAWY RISEN 450 + Inwerter Sieciowy GOODWE + MAGAZYN WYSOKONAPIĘCIOWY:</label>
                <select id="zestaw-wysokonapieciowy" class="lista-produktow" disabled></select>

                <label>ZESTAW PREMIUM (SigenStor):</label>
                <select id="zestaw-premium" class="lista-produktow" disabled></select>

                <button onclick="przejdzDoEtapu(2)">Dalej &rarr;</button>
            </div>
            
            <div id="etap2" class="etap ukryty">
                <h2>Krok 2: Dodatki i Magazyny</h2>
                <label>Zwiększenie magazynu DEYE:</label>
                <select id="mag-deye">
                    <option value="0" data-price="0">Brak</option>
                    <option value="10" data-price="3500">Zwiększenie DEYE do 10kWh (+3500 zł)</option>
                    <option value="14" data-price="4500">Zwiększenie DEYE do 14,3kWh (+4500 zł)</option>
                    <option value="16" data-price="5500">Zwiększenie DEYE do 16kWh (+5500 zł)</option>
                    <option value="23" data-price="8500">Zwiększenie DEYE do 23,5kWh (+8500 zł)</option>
                </select>

                <label>Zwiększenie magazynu SIGENSTOR:</label>
                <select id="mag-sigen">
                    <option value="0" data-price="0">Brak</option>
                    <option value="10" data-price="3300">Zwiększenie SIGENSTOR do 10kW (+3300 zł)</option>
                </select>

                <label>ŁADOWARKA SAMOCHODOWA:</label>
                <select id="wallbox">
                    <option value="0" data-price="0">Brak</option>
                    <option value="11" data-price="4300">Green Wallbox 2 Pro Slim 11kW 6m (4300 zł)</option>
                    <option value="22" data-price="4700">Green Wallbox 2 Pro Slim 22kW 6m (4700 zł)</option>
                </select>

                <div class="form-buttons">
                    <button onclick="przejdzDoEtapu(1)">Wstecz</button>
                    <button onclick="przejdzDoEtapu(3)">Dalej</button>
                </div>
            </div>

            <div id="etap3" class="etap ukryty">
                <h2>Krok 3: Dane do PDF</h2>
                <input type="text" id="k-imie" placeholder="Imię i Nazwisko Klienta">
                <input type="text" id="k-adres" placeholder="Adres montażu">
                <input type="text" id="h-imie" placeholder="Imię Handlowca">
                <input type="tel" id="h-tel" placeholder="Telefon Handlowca">
                <label>Stawka VAT:</label>
                <select id="vat-select"><option value="0.08">8%</option><option value="0.23">23%</option></select>
                <label>Marża (%):</label>
                <input type="number" id="marza-input" value="0">
                <button onclick="generujPDF()">GENERUJ PDF OFERTY</button>
                <div class="form-buttons"><button onclick="przejdzDoEtapu(2)">Wstecz</button></div>
            </div>
        </div>
        
        <div id="stale-podsumowanie">
            <h3>Wybrane elementy:</h3>
            <ul id="lista-wybranych-elementow"></ul>
            <h3>Cena końcowa Brutto: <span id="cena-brutto-display">0.00</span> PLN</h3>
        </div>
    </div>

<script>
    const POPRAWNE_HASLO = "GreenNow777!";
    const GLOBALNA_KOREKTA = 0; // Podwyżki o 500zł są już wliczone w ceny poniżej

    const BAZA = {
        "zestawy_sieciowe": {
            "TRAPEZ": [ { name: "TRAPEZ 3,15 KWP RISEN + DEYE 1F", price: 13060 }, { name: "TRAPEZ 19,8 KWP RISEN + DEYE 3F", price: 33050 } ],
            "GRUNT": [ { name: "GRUNT 3,15 KWP RISEN + DEYE 1F", price: 14194 }, { name: "GRUNT 19,8 KWP RISEN + DEYE 3F", price: 38900 } ],
            "DACHÓWKA": [ { name: "DACHÓWKA 3,15 KWP RISEN + DEYE 1F", price: 13683 }, { name: "DACHÓWKA 19,8 KWP RISEN + DEYE 3F", price: 36200 } ],
            "BLACHODACHÓWKA": [ { name: "BLACHODACHÓWKA 3,15 KWP RISEN + DEYE 1F", price: 13496.10 }, { name: "BLACHODACHÓWKA 19,8 KWP RISEN + DEYE 3F", price: 35120 } ],
            "EKIERKI": [ { name: "EKIERKI 3,15 KWP RISEN + DEYE 1F", price: 13847.50 }, { name: "EKIERKI 19,8 KWP RISEN + DEYE 3F", price: 37055 } ]
        },
        "zestawy_niskonapieciowe": {
            "TRAPEZ": [ { name: "TRAPEZ 3,15 KWP RISEN + DEYE + Felicity 5kWh", price: 24060 }, { name: "TRAPEZ 19,8 KWP RISEN + DEYE + Felicity 5kWh", price: 44150 } ],
            "GRUNT": [ { name: "GRUNT 3,15 KWP RISEN + DEYE + Felicity 5kWh", price: 25381.40 }, { name: "GRUNT 19,8 KWP RISEN + DEYE + Felicity 5kWh", price: 49755 } ]
        },
        "zestawy_wysokonapieciowe": {
            "TRAPEZ": [ { name: "TRAPEZ 3,15 KWP RISEN + GOODWE 3F", price: 26160 }, { name: "TRAPEZ 19,8 KWP RISEN + GOODWE 3F", price: 46150 } ]
        },
        "zestawy_premium": {
            "TRAPEZ": [ { name: "TRAPEZ 3,15 KWP RISEN + Sigen Hybrid TP2", price: 27160 }, { name: "TRAPEZ 19,8 KWP RISEN + Sigen Hybrid TP2", price: 47150 } ],
            "GRUNT": [ { name: "GRUNT 3,15 KWP RISEN + Sigen Hybrid TP2", price: 27694 }, { name: "GRUNT 19,8 KWP RISEN + Sigen Hybrid TP2", price: 52000 } ]
        }
    };

    document.getElementById('btn-zaloguj').addEventListener('click', function() {
        const wpisane = document.getElementById('haslo-dostepu').value;
        if(wpisane === POPRAWNE_HASLO) {
            document.getElementById('prosty-login').classList.add('ukryty');
            document.getElementById('glowny-kalkulator').classList.remove('ukryty');
        } else {
            document.getElementById('login-error').innerText = "Błędne hasło!";
        }
    });

    function przejdzDoEtapu(nr) {
        document.querySelectorAll('.etap').forEach(e => e.classList.add('ukryty'));
        document.getElementById(`etap${nr}`).classList.remove('ukryty');
    }

    function odswiezWszystkieListy() {
        const typ = document.getElementById('typ-pokrycia').value;
        const mapping = {
            'zestaw-sieciowy': 'zestawy_sieciowe',
            'zestaw-niskonapieciowy': 'zestawy_niskonapieciowe',
            'zestaw-wysokonapieciowy': 'zestawy_wysokonapieciowe',
            'zestaw-premium': 'zestawy_premium'
        };

        for (let id in mapping) {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="0" data-price="0">-- Wybierz --</option>';
            const produkty = BAZA[mapping[id]][typ] || [];
            produkty.forEach(p => {
                const opt = new Option(p.name, p.name);
                opt.dataset.price = p.price;
                el.add(opt);
            });
            el.disabled = produkty.length === 0;
        }
        aktualizuj();
    }

    function aktualizuj() {
        const getP = (id) => {
            const s = document.getElementById(id);
            return (s && s.selectedIndex > 0) ? parseFloat(s.options[s.selectedIndex].dataset.price) : 0;
        };
        const getT = (id) => {
            const s = document.getElementById(id);
            return (s && s.selectedIndex > 0) ? s.options[s.selectedIndex].text : "";
        };

        let cenaGlowna = 0;
        let nazwaGlowna = "";
        ['zestaw-sieciowy', 'zestaw-niskonapieciowy', 'zestaw-wysokonapieciowy', 'zestaw-premium'].forEach(id => {
            if(getP(id) > 0) { cenaGlowna = getP(id); nazwaGlowna = getT(id); }
        });

        const sumaBazowa = cenaGlowna + getP('mag-deye') + getP('mag-sigen') + getP('wallbox');
        const marza = parseFloat(document.getElementById('marza-input').value) || 0;
        const vat = parseFloat(document.getElementById('vat-select').value) || 0.08;
        
        const netto = sumaBazowa * (1 + marza/100);
        const brutto = netto * (1 + vat);

        document.getElementById('cena-brutto-display').innerText = brutto.toFixed(2);
        
        const uiList = document.getElementById('lista-wybranych-elementow');
        uiList.innerHTML = nazwaGlowna ? `<li>${nazwaGlowna}</li>` : "";
        if(getP('wallbox') > 0) uiList.innerHTML += `<li>Ładowarka: ${getT('wallbox')}</li>`;
        
        return { nazwaGlowna, netto, brutto, vat };
    }

    // PDF 
    function generujPDF() {
        const dane = aktualizuj();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const f = (s) => s ? s.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ł/g, 'l').replace(/Ł/g, 'L') : "";

        doc.setTextColor(0, 91, 65); doc.setFontSize(22); doc.setFont("helvetica", "bold");
        doc.text(f("Oferta Handlowa"), 195, 25, { align: "right" });

        doc.setFontSize(11); doc.text(f("NABYWCA"), 15, 65); doc.text(f("SPRZEDAWCA"), 105, 65);
        doc.line(15, 67, 195, 67);

        doc.setTextColor(0); doc.text(f(document.getElementById('k-imie').value), 15, 75);
        doc.text(f("GREEN NOW SP. Z O.O."), 105, 75);
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(f(document.getElementById('k-adres').value), 15, 82);
        doc.text(f("Handlowiec: " + document.getElementById('h-imie').value), 105, 82);
        doc.text(f("Tel: " + document.getElementById('h-tel').value), 105, 89);

        doc.autoTable({
            startY: 110,
            head: [[f('ZAKRES PRAC I MATERIALOW')]],
            body: [[f("- " + dane.nazwaGlowna)], [f("- Ladowarka EV: " + getT('wallbox'))]],
            theme: 'plain'
        });

        const finalY = doc.lastAutoTable.finalY + 15;
        doc.autoTable({
            startY: finalY, margin: { left: 110 },
            body: [[f("Wartosc Netto:"), dane.netto.toFixed(2) + " zl"], [f("Brutto:"), dane.brutto.toFixed(2) + " zl"]],
            theme: 'grid', styles: { fontStyle: 'bold', halign: 'right' }
        });

        doc.save("Oferta.pdf");
    }

    document.querySelectorAll('input, select').forEach(el => el.addEventListener('change', aktualizuj));
    document.querySelectorAll('.lista-produktow').forEach(s => {
        s.addEventListener('change', function() {
            if(this.value !== '0') {
                document.querySelectorAll('.lista-produktow').forEach(o => { if(o !== this) o.value = '0'; });
            }
            aktualizuj();
        });
    });

</script>
</body>
</html>
